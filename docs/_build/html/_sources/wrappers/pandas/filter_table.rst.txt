.. _`bio/pandas/filter_table`:

FILTER TABLE
============

Filter your TSV file with pandas


Example
-------

This wrapper can be used in the following way:

.. code-block:: python

    rule test_filter_table:
        input:
            table = "table.tsv"
        output:
            table = "filtered.tsv"
        params:
            keep_column = ["a", "b"],
            filter = [["a", ">=", 2.3]]
        log:
            "filter.log"
        wrapper:
            "0.72.0-560-g28998a654/bio/pandas/filter_table"

Note that input, output and log file paths can be chosen freely.
When running with

.. code-block:: bash

    snakemake --use-conda

the software dependencies will be automatically deployed into an isolated environment before execution.

Software dependencies
---------------------

* ``conda-forge:python=3.8.2``
* ``conda-forge:pandas=1.0.1``
* ``conda-forge:numpy=1.18.1``

Input/Output
------------
**Input:**

* A single TSV table

**Output:**

* A filtered TSV table



Notes
-----

Parameters:

* keep_column (List[str]): a list of column name to keep. Leave empty to keep all columns
* keep_line (List[str]): a list of lines to keep. Leave empty to keep all lines
* filters (List[Union[str, int, float]]): a list of filters to apply and the column to which apply this filter



Authors
-------

* Thibault Dayris


Code
----

.. code-block:: python

    #!/usr/bin/python3.8
    # conding: utf-8

    """
    Filter a TSV file
    """

    __author__ = "Thibault Dayris"
    __copyright__ = "Copyright 2020, Thibault Dayris"
    __email__ = "thibault.dayris@gustaveroussy.fr"
    __license__ = "MIT"


    import logging
    import operator
    import pandas
    import numpy
    from typing import Union


    def filter_dataframe(dataframe: pandas.DataFrame,
                         column: Union[str, int],
                         operator: str,
                         value: Union[int, float]):
        """
        Filter a dataframe according to the column, value and boolean
        operator
        """
        operator = ops[operator]
        return dataframe[operator(dataframe[column], value)]

    logging.basicConfig(
        filename=snakemake.log[0],
        filemode="w",
        level=logging.DEBUG
    )

    ops = {
        ">": operator.gt,
        ">=": operator.ge,
        "==": operator.eq,
        "<": operator.lt,
        "<=": operator.le,
        "!=": operator.ne
    }

    if (sep := snakemake.params.get("separator", "\t")) != "\t":
        sep = snakemake.params["separator"]

    data = pandas.read_csv(
        snakemake.input["table"],
        sep=sep,
        header=0
    )

    if (cols := snakemake.params.get("keep_column", None)) is not None:
        logging.debug(f"The following columns are kept: {cols}")
        data = data[cols]

    if (line := snakemake.params.get("keep_line", None)) is not None:
        logging.debug(f"The following columns are kept: {line}")
        data = data[line]

    if (filters := snakemake.params.get("filters", None)) is not None:
        logging.debug(f"The table will be filtered according to: {filters}")
        for filter in filters:
            data = filter_dataframe(data.copy, *filter)

    if (drop_any_na := snakemake.params.get("dropna", False)) is True:
        logging.debug("Dropping NAs")
        data.dropna(axis=0, how="any", inplace=True)

    logging.debug(f"Head of the final DataFrame:\n{data.head()}")

    data.to_csv(
        snakemake.output["table"],
        sep=sep,
        index=False
    )
